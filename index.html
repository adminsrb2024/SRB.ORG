<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sreenagar Rokter Bondhon</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary: #d71920;
  --primary-dark: #9b0d12;
  --primary-light: #ffebee;
  --text: #2c3e50;
  --text-light: #7f8c8d;
  --bg: #f4f6f9;
  --card-bg: #ffffff;
  --shadow: 0 10px 30px rgba(0,0,0,0.08);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif}
body{background:var(--bg);padding-bottom:90px; color: var(--text);}

/* ANIMATIONS */
@keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
@keyframes slideIn { from{transform:translateX(-100%)} to{transform:translateX(0)} }
@keyframes pulse { 0%{transform:scale(1); box-shadow:0 0 0 0 rgba(215, 25, 32, 0.4)} 70%{transform:scale(1.05); box-shadow:0 0 0 10px rgba(215, 25, 32, 0)} 100%{transform:scale(1)} }

/* HEADER */
.header{
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color:white;
  padding:15px 20px;
  position:fixed;
  width: 100%;
  top:0;
  z-index:100;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow: 0 4px 20px rgba(215, 25, 32, 0.25);
}
.header-left { display: flex; align-items: center; gap: 12px; }
.menuBtn{ font-size:22px; cursor:pointer; transition: 0.3s; padding: 5px; }
.menuBtn:hover { transform: scale(1.1); }
.header-logo{ width: 42px; height: 42px; object-fit: cover; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.header-title { font-size: 17px; font-weight: 700; letter-spacing: -0.3px; }
.header-subtitle { font-size: 10px; opacity: 0.9; font-weight: 400; }

/* MAIN CONTAINER */
.main-container{padding-top:70px; padding-bottom: 20px;}
.container{padding:15px; animation: fadeIn 0.6s ease;}
.container.hidden{display:none}

/* CARDS */
.card{
  background:var(--card-bg);
  border-radius:16px;
  padding:20px;
  box-shadow: var(--shadow);
  margin-bottom:20px;
  border: 1px solid rgba(0,0,0,0.02);
}
.card-title {
  font-size: 16px;
  color: var(--text);
  font-weight: 700;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-title i { color: var(--primary); }

/* HERO SECTION */
.hero-card {
  background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
  border-left: 5px solid var(--primary);
  position: relative;
  overflow: hidden;
}
.hero-card::after {
  content: "\f055";
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  position: absolute;
  right: -10px;
  bottom: -10px;
  font-size: 100px;
  color: rgba(215, 25, 32, 0.05);
}
.hero-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #eee;
}
.stat-item { text-align: center; }
.stat-num { font-size: 20px; font-weight: 800; color: var(--primary); }
.stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; }

/* GRID DASHBOARD */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.dash-card {
  background: white;
  padding: 18px 15px;
  border-radius: 16px;
  text-align: center;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: 0.3s;
  position: relative;
  overflow: hidden;
}
.dash-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
.dash-card:active { transform: scale(0.98); }
.dash-icon {
  width: 45px;
  height: 45px;
  background: var(--primary-light);
  color: var(--primary);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  margin: 0 auto 10px;
  transition: 0.3s;
}
.dash-card:hover .dash-icon { background: var(--primary); color: white; }
.dash-title { font-weight: 600; font-size: 14px; color: var(--text); }
.dash-desc { font-size: 10px; color: var(--text-light); margin-top: 3px; }

/* FORMS */
.form-group { margin-bottom: 15px; }
.form-label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
input, select, textarea{
  width:100%;
  padding:14px;
  border:2px solid #f0f0f0;
  border-radius:10px;
  transition: 0.3s;
  background: #fafafa;
  font-size: 14px;
  color: var(--text);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 4px rgba(215, 25, 32, 0.05);
}
button.primary-btn{
  width:100%;
  padding:15px;
  border:none;
  border-radius:12px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color:white;
  font-size:15px;
  font-weight: 700;
  cursor:pointer;
  box-shadow: 0 8px 20px rgba(215, 25, 32, 0.3);
  transition: 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
button.primary-btn:hover{ transform: translateY(-2px); box-shadow: 0 10px 25px rgba(215, 25, 32, 0.4); }
button.primary-btn:active { transform: translateY(0); }

/* DONOR & REQUEST CARD STYLE */
.donor-card {
  display: flex;
  align-items: center;
  background: white;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 12px;
  border: 1px solid #eee;
  transition: 0.3s;
}
.donor-card:hover { border-color: var(--primary); }
/* Urgent Request Specific Style */
.urgent-card {
  border-left: 4px solid var(--primary);
  background: #fffafa;
}
.donor-avatar {
  width: 50px;
  height: 50px;
  background: var(--primary-light);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary);
  font-weight: 800;
  font-size: 16px;
  margin-right: 15px;
  border: 2px solid white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.urgent-card .donor-avatar {
  background: var(--primary);
  color: white;
}
.donor-info h4 { font-size: 15px; margin-bottom: 4px; color: var(--text); }
.donor-info p { font-size: 12px; color: var(--text-light); display: flex; align-items: center; gap: 4px; }
.donor-call-btn {
  margin-left: auto;
  background: #25D366;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-size: 18px;
  box-shadow: 0 3px 10px rgba(37, 211, 102, 0.3);
}

/* INFO TABLE */
.info-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
.info-table th, .info-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
.info-table th { background: #fafafa; color: var(--text); font-weight: 600; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 11px; background: var(--primary-light); color: var(--primary); }

/* ELIGIBILITY LIST */
.check-list { list-style: none; }
.check-list li { display: flex; align-items: flex-start; margin-bottom: 12px; font-size: 13px; color: var(--text-light); line-height: 1.5; }
.check-list li i { color: #25D366; margin-right: 10px; margin-top: 3px; font-size: 12px; }
.fail-list li i { color: var(--primary); }

/* FOOTER */
.footer{
  position:fixed; bottom:0; left:0;
  width:100%; background: white;
  text-align:center;
  padding:12px 20px;
  border-top: 1px solid #eee;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 99;
}
.footer-left { text-align: left; }
.footer-right { text-align: right; }
.footer span { display: block; }
.dev-name { font-size: 11px; color: var(--text-light); font-weight: 500; }
.dev-comp { font-size: 13px; color: var(--text); font-weight: 700; }
.hotline-link {
  background: var(--primary);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  text-decoration: none;
  font-weight: 600;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

/* MENU OVERLAY */
.overlay{ position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:998; display:none; backdrop-filter: blur(3px); }

/* DRAWER */
.menu{ position:fixed; left:-300px; top:0; width:280px; height:100%; background:white; transition:.3s ease-in-out; z-index:999; box-shadow: 5px 0 30px rgba(0,0,0,0.1); }
.menu.active{left:0}
.menu-header { background: var(--primary); color: white; padding: 30px 20px; margin-bottom: 10px; }
.menu-header h3 { font-size: 20px; font-weight: 700; }
.menu-header p { font-size: 12px; opacity: 0.9; margin-top: 5px; }
.menu a{ display:flex; align-items: center; padding:16px 25px; color:#444; text-decoration:none; transition: 0.2s; font-weight: 500; font-size: 14px; }
.menu a i { margin-right: 15px; color: #aaa; width: 20px; font-size: 16px; }
.menu a:hover { background: #fff5f5; color: var(--primary); }
.menu a:hover i { color: var(--primary); }

/* SPLASH SCREEN */
#splash { height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background: white; z-index: 1000; position: fixed; top: 0; left: 0; width: 100%; }
.splash-logo-container { width: 130px; height: 130px; border-radius: 50%; background: white; padding: 5px; box-shadow: 0 10px 40px rgba(215, 25, 32, 0.3); margin-bottom: 25px; animation: pulse 2s infinite; }
.splash-logo { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.splash-text { font-size: 22px; color: var(--primary); font-weight: 800; letter-spacing: -0.5px; }
.splash-sub { font-size: 12px; color: var(--text-light); margin-top: 5px; margin-bottom: 30px; }
.loader { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* UTILITY */
.hidden {display:none}
.mb-10 { margin-bottom: 10px; }
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splash">
  <div class="splash-logo-container">
    <img src="https://z-cdn-media.chatglm.cn/files/3bd2ac78-e146-4d71-b99d-ac64f35f4bf9.jpg?auth_key=1871394197-effa948b636c4ab781ba1fcfe3fa18d2-0-dba95b4ab61b5cf4ea7d439516b245d9" class="splash-logo" alt="Logo">
  </div>
  <div class="splash-text">Sreenagar Rokter Bondhon</div>
  <div class="splash-sub">Connecting Lives</div>
  <div class="loader"></div>
</div>

<!-- APP CONTAINER -->
<div id="app" class="hidden">

<div class="header">
  <div class="header-left">
    <span class="menuBtn" onclick="toggleMenu()"><i class="fas fa-bars"></i></span>
    <img src="https://z-cdn-media.chatglm.cn/files/3bd2ac78-e146-4d71-b99d-ac64f35f4bf9.jpg?auth_key=1871394197-effa948b636c4ab781ba1fcfe3fa18d2-0-dba95b4ab61b5cf4ea7d439516b245d9" class="header-logo" alt="Logo">
  </div>
  <div style="text-align:right">
    <div class="header-title">Sreenagar Rokter Bondhon</div>
    <div class="header-subtitle">Voluntary Blood Donation</div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<!-- MENU -->
<div class="menu" id="menu">
  <div class="menu-header">
    <h3>Menu</h3>
    <p>Donate Blood, Save Life</p>
  </div>
  <a onclick="openPage('home')"><i class="fas fa-home"></i> Dashboard</a>
  <a onclick="openPage('findDonor')"><i class="fas fa-search-location"></i> Find Donor</a>
  <a onclick="openPage('request')"><i class="fas fa-notes-medical"></i> Request Blood</a>
  <a onclick="openPage('beDonor')"><i class="fas fa-user-plus"></i> Register as Donor</a>
  <a onclick="openPage('bloodInfo')"><i class="fas fa-tint"></i> Blood Group Info</a>
  <a onclick="openPage('eligibility')"><i class="fas fa-clipboard-check"></i> Eligibility</a>
  <a onclick="openPage('about')"><i class="fas fa-info-circle"></i> About Us</a>
  <div style="border-top:1px solid #eee; margin:10px 0;"></div>
  <a href="https://facebook.com/groups/776274101742103/" target="_blank"><i class="fab fa-facebook"></i> Join Community</a>
</div>

<div class="main-container">

<!-- HOME PAGE -->
<div id="home" class="container">
  <div class="card hero-card">
    <div class="card-title"><i class="fas fa-heartbeat"></i> Welcome</div>
    <p style="font-size: 14px; color: #666; line-height: 1.6;">
      Every drop counts. Join our mission to save lives by donating blood today.
    </p>
    <div class="hero-stats">
      <div class="stat-item">
        <div class="stat-num" id="statDonors">-</div>
        <div class="stat-label">Active Donors</div>
      </div>
      <div class="stat-item">
        <div class="stat-num" id="statRequests">-</div>
        <div class="stat-label">Pending Requests</div>
      </div>
      <div class="stat-item">
        <div class="stat-num">24/7</div>
        <div class="stat-label">Service</div>
      </div>
    </div>
  </div>

  <!-- Recent Blood Requests Section (NEW) -->
  <div class="card">
    <div class="card-title"><i class="fas fa-bell"></i> Recent Blood Requests</div>
    <div id="recentRequestsList">
        <p style="text-align:center; color:#888; font-size:13px;">Loading requests...</p>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="dash-card" onclick="openPage('findDonor')">
      <div class="dash-icon"><i class="fas fa-search"></i></div>
      <div class="dash-title">Find Donor</div>
      <div class="dash-desc">Search nearby</div>
    </div>
    <div class="dash-card" onclick="openPage('request')">
      <div class="dash-icon"><i class="fas fa-ambulance"></i></div>
      <div class="dash-title">Request Blood</div>
      <div class="dash-desc">Urgent need</div>
    </div>
    <div class="dash-card" onclick="openPage('beDonor')">
      <div class="dash-icon"><i class="fas fa-user-plus"></i></div>
      <div class="dash-title">Be a Donor</div>
      <div class="dash-desc">Join us</div>
    </div>
    <div class="dash-card" onclick="openPage('eligibility')">
      <div class="dash-icon"><i class="fas fa-clipboard-list"></i></div>
      <div class="dash-title">Eligibility</div>
      <div class="dash-desc">Check now</div>
    </div>
  </div>
</div>

<!-- FIND DONOR PAGE -->
<div id="findDonor" class="container hidden">
  <div class="card">
    <div class="card-title"><i class="fas fa-search"></i> Search Blood Group</div>
    <select id="searchBlood" onchange="filterDonors()" class="mb-10">
      <option value="">-- Select Blood Group --</option>
      <option value="A+">A+</option>
      <option value="A-">A-</option>
      <option value="B+">B+</option>
      <option value="B-">B-</option>
      <option value="O+">O+</option>
      <option value="O-">O-</option>
      <option value="AB+">AB+</option>
      <option value="AB-">AB-</option>
    </select>
  </div>
  <div id="donorListContainer">
    <div class="card" style="text-align: center; color: #888; border: 1px dashed #ccc;">
      <i class="fas fa-users" style="font-size: 40px; margin-bottom: 10px; display:block;"></i>
      <p>Select a blood group above to see available donors.</p>
    </div>
  </div>
</div>

<!-- REQUEST BLOOD PAGE -->
<div id="request" class="container hidden">
  <div class="card">
    <div class="card-title"><i class="fas fa-notes-medical"></i> Post Blood Request</div>
    <p style="font-size:12px; color:#999; margin-bottom:15px;">This request will be public on the home page.</p>
    <div class="form-group">
      <label class="form-label">Patient Name</label>
      <input id="patient" placeholder="Full Name">
    </div>
    <div class="form-group">
      <label class="form-label">Blood Group Needed</label>
      <select id="reqBlood">
        <option>A+</option><option>B+</option><option>O+</option><option>AB+</option>
        <option>A-</option><option>B-</option><option>O-</option><option>AB-</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Hospital / Location</label>
      <input id="location" placeholder="e.g., Dhaka Medical">
    </div>
    <div class="form-group">
      <label class="form-label">Contact Number</label>
      <input id="reqContact" type="tel" placeholder="01XXXXXXXXX">
    </div>
    <div class="form-group">
      <label class="form-label">Required Date</label>
      <input id="reqDate" type="date">
    </div>
    <button class="primary-btn" onclick="submitBloodRequest()"><i class="fas fa-paper-plane"></i> Submit Request</button>
  </div>
</div>

<!-- BE A DONOR PAGE -->
<div id="beDonor" class="container hidden">
  <div class="card">
    <div class="card-title"><i class="fas fa-user-plus"></i> Register as Donor</div>
    <p style="font-size:12px; color:green; margin-bottom:15px;"><i class="fas fa-info-circle"></i> Your information will be saved to our online database.</p>
    <div class="form-group">
      <label class="form-label">Full Name</label>
      <input id="donorName" placeholder="Your Name">
    </div>
    <div class="form-group">
      <label class="form-label">Blood Group</label>
      <select id="donorBlood">
        <option>A+</option><option>B+</option><option>O+</option><option>AB+</option>
        <option>A-</option><option>B-</option><option>O-</option><option>AB-</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Mobile Number</label>
      <input id="donorPhone" type="tel" placeholder="01XXXXXXXXX">
    </div>
    <div class="form-group">
      <label class="form-label">Location</label>
      <input id="donorLocation" placeholder="Village/Area Name">
    </div>
    <button class="primary-btn" onclick="registerDonor()"><i class="fas fa-check-circle"></i> Register Now</button>
  </div>
</div>

<!-- ELIGIBILITY PAGE -->
<div id="eligibility" class="container hidden">
  <div class="card">
    <div class="card-title"><i class="fas fa-clipboard-check"></i> Who Can Donate?</div>
    <h4 style="color:#28a745; font-size:14px; margin-bottom:10px;"><i class="fas fa-check"></i> You CAN Donate If:</h4>
    <ul class="check-list">
      <li><i class="fas fa-check"></i> You are between 18-60 years old.</li>
      <li><i class="fas fa-check"></i> Your weight is at least 45 kg.</li>
    </ul>
    <div style="height:1px; background:#eee; margin:15px 0;"></div>
    <h4 style="color:var(--primary); font-size:14px; margin-bottom:10px;"><i class="fas fa-times"></i> You CANNOT Donate If:</h4>
    <ul class="check-list fail-list">
      <li><i class="fas fa-times"></i> You have cold, flu, or fever.</li>
    </ul>
  </div>
</div>

<!-- BLOOD INFO PAGE -->
<div id="bloodInfo" class="container hidden">
  <div class="card">
    <div class="card-title"><i class="fas fa-tint"></i> Blood Compatibility</div>
    <table class="info-table">
      <thead>
        <tr><th>Group</th><th>Donate To</th><th>Receive From</th></tr>
      </thead>
      <tbody>
        <tr><td><span class="badge">A+</span></td><td>A+, AB+</td><td>A+, A-, O+, O-</td></tr>
        <tr><td><span class="badge">O-</span></td><td>ALL</td><td>O-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ABOUT PAGE -->
<div id="about" class="container hidden">
  <div class="card">
    <div class="card-title"><i class="fas fa-users"></i> About Organization</div>
    <p style="color:#555; line-height:1.6; font-size: 13px;">
      <strong>Sreenagar Rokter Bondhon</strong> is a voluntary blood donation organization.
    </p>
  </div>
</div>

</div>

<div class="footer">
  <div class="footer-left">
    <span class="dev-name">Developed by</span>
    <span class="dev-comp">SRP SOFT LTD.</span>
  </div>
  <div class="footer-right">
    <a href="tel:+8809697755193" class="hotline-link">
      <i class="fas fa-phone-alt"></i> Hotline
    </a>
  </div>
</div>

</div>

<!-- SUPABASE SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- EMAILJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
// ==========================================
// CONFIGURATION SECTION
// ==========================================

const SUPABASE_URL = 'https://qhftnurfbqdtkccffagm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoZnRudXJmYnFkdGtjY2ZmYWdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MTA0MjcsImV4cCI6MjA4NzQ4NjQyN30.pNEjziqmkIP5vIC7Iu2Qwkz25cysKHoVMXJme5ARwTE';

const ADMIN_EMAIL = "omorhosshin@gmail.com";
const EMAILJS_PUBLIC_KEY = "tTDL_g9ChY2fiUl4t";
const EMAILJS_SERVICE_ID = "service_rka3imy";
const EMAILJS_TEMPLATE_ID = "template_5j956tn";

// Initialize Clients
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
if(typeof emailjs !== 'undefined'){ emailjs.init(EMAILJS_PUBLIC_KEY); }

// ==========================================
// APP LOGIC
// ==========================================

// Splash Screen
setTimeout(()=>{
  document.getElementById("splash").style.display="none";
  document.getElementById("app").classList.remove("hidden");
  updateDonorCount();
  loadRecentRequests(); // Load requests on startup
}, 2500);

// Update Dashboard Stats
async function updateDonorCount() {
    try {
        // Count Donors
        const { count: donorCount, error: err1 } = await supabaseClient
            .from('donors')
            .select('*', { count: 'exact', head: true });
        if (!err1) document.getElementById('statDonors').innerText = donorCount + '+';

        // Count Pending Requests
        const { count: reqCount, error: err2 } = await supabaseClient
            .from('requests')
            .select('*', { count: 'exact', head: true });
        if (!err2) document.getElementById('statRequests').innerText = reqCount + '+';
            
    } catch (err) {
        console.error("Error fetching stats:", err);
    }
}

// Load Recent Requests to Home Page
async function loadRecentRequests() {
    const container = document.getElementById('recentRequestsList');
    try {
        const { data, error } = await supabaseClient
            .from('requests')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(5); // Show last 5 requests

        if (error) throw error;

        container.innerHTML = "";
        if(data.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#888; font-size:13px;'>No active requests right now.</p>";
            return;
        }

        data.forEach(req => {
            const html = `
                <div class="donor-card urgent-card">
                    <div class="donor-avatar">${req.blood_group}</div>
                    <div class="donor-info">
                        <h4>${req.patient_name}</h4>
                        <p><i class="fas fa-hospital"></i> ${req.location}</p>
                        <p><i class="fas fa-calendar"></i> Need: ${req.required_date}</p>
                    </div>
                    <a href="tel:${req.contact}" class="donor-call-btn"><i class="fas fa-phone-alt"></i></a>
                </div>
            `;
            container.innerHTML += html;
        });
    } catch(e) {
        container.innerHTML = "<p style='color:red; text-align:center;'>Error loading requests.</p>";
    }
}

// Menu Toggle
function toggleMenu(){
  const menu = document.getElementById("menu");
  const overlay = document.getElementById("overlay");
  menu.classList.toggle("active");
  overlay.style.display = menu.classList.contains("active") ? "block" : "none";
}

// Page Navigation
function hidePages(){
  ["home", "findDonor", "request", "beDonor", "bloodInfo", "eligibility", "about"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
  });
}

function openPage(id){
  hidePages();
  document.getElementById(id).classList.remove("hidden");
  window.scrollTo(0, 0);
  const menu = document.getElementById("menu");
  if(menu.classList.contains("active")) toggleMenu();
}

// ==========================================
// DATABASE ACTIONS
// ==========================================

// 1. REGISTER NEW DONOR
async function registerDonor() {
    const name = document.getElementById("donorName").value;
    const phone = document.getElementById("donorPhone").value;
    const blood = document.getElementById("donorBlood").value;
    const location = document.getElementById("donorLocation").value;

    if(!name || !phone || !location) { alert("Please fill all fields!"); return; }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Saving...";

    try {
        const { error } = await supabaseClient
            .from('donors')
            .insert([{ name: name, blood: blood, phone: phone, location: location }]);

        if (error) throw error;

        alert("Success! You are now registered.");
        
        // Send Email
        const templateParams = { 
            to_email: ADMIN_EMAIL, 
            subject: "New Donor Registration", 
            message: `Name: ${name}\nBlood: ${blood}\nPhone: ${phone}\nLoc: ${location}` 
        };
        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

        // Reset
        document.getElementById("donorName").value = "";
        document.getElementById("donorPhone").value = "";
        document.getElementById("donorLocation").value = "";
        updateDonorCount();
        openPage('home');

    } catch (err) {
        alert("Error saving data.");
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.innerHTML = "<i class='fas fa-user-plus'></i> Register Now";
    }
}

// 2. SUBMIT BLOOD REQUEST (Updated)
async function submitBloodRequest() {
    const patient = document.getElementById("patient").value;
    const location = document.getElementById("location").value;
    const contact = document.getElementById("reqContact").value;
    const blood = document.getElementById("reqBlood").value;
    const date = document.getElementById("reqDate").value;

    if(!patient || !location || !contact || !date) { alert("Please fill all fields!"); return; }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Posting...";

    try {
        // Save to Database
        const { error } = await supabaseClient
            .from('requests')
            .insert([{
                patient_name: patient,
                blood_group: blood,
                location: location,
                contact: contact,
                required_date: date
            }]);

        if (error) throw error;

        // Send Email Notification
        const templateParams = { 
            to_email: ADMIN_EMAIL, 
            subject: "URGENT: Blood Request", 
            message: `Patient: ${patient}\nBlood: ${blood}\nLoc: ${location}\nContact: ${contact}\nDate: ${date}` 
        };
        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

        alert("Request Posted Successfully! It is now visible to everyone.");
        
        // Refresh Data
        loadRecentRequests();
        updateDonorCount();
        
        openPage('home');

    } catch (err) {
        alert("Error submitting request.");
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.innerHTML = "<i class='fas fa-paper-plane'></i> Submit Request";
    }
}

// 3. FIND DONOR
async function filterDonors() {
    const selectedBlood = document.getElementById("searchBlood").value;
    const container = document.getElementById("donorListContainer");
    container.innerHTML = "";

    if (!selectedBlood) {
        container.innerHTML = `<div class="card" style="text-align: center; color: #888;"><p>Select a blood group.</p></div>`;
        return;
    }

    container.innerHTML = `<div class="card" style="text-align:center;"><div class="loader" style="margin:10px auto;"></div><p>Loading donors...</p></div>`;

    try {
        const { data, error } = await supabaseClient
            .from('donors')
            .select('*')
            .eq('blood', selectedBlood);

        if (error) throw error;

        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = `<div class="card" style="text-align: center; color: #888;"><i class="fas fa-sad-tear" style="font-size: 30px;"></i><p style="margin-top:10px">No donors found for ${selectedBlood}.</p></div>`;
        } else {
            data.forEach(donor => {
                const html = `
                    <div class="donor-card">
                        <div class="donor-avatar">${donor.blood}</div>
                        <div class="donor-info">
                            <h4>${donor.name}</h4>
                            <p><i class="fas fa-map-marker-alt"></i> ${donor.location}</p>
                        </div>
                        <a href="tel:${donor.phone}" class="donor-call-btn"><i class="fas fa-phone-alt"></i></a>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

    } catch (err) {
        container.innerHTML = `<div class="card" style="text-align: center; color: red;"><p>Error loading data.</p></div>`;
        console.error(err);
    }
}
</script>
</body>
</html>
